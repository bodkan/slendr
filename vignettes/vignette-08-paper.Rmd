---
title: "Examples from the slendr paper"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Examples from the slendr paper}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  fig.width = 6,
  fig.height = 4,
  dpi = 80,
  eval = TRUE
)

# for some reason knitr/reticulate sets this to default, sabotaging
# our efforts to make reticulate use our custom environment -- this
# appears to solve the problem
Sys.unsetenv("RETICULATE_PYTHON")

devtools::load_all(".")

RANDOM_SEED <- 314159L
set.seed(RANDOM_SEED)

library(dplyr)
library(readr)
library(ggplot2)
library(purrr)

reticulate::use_condaenv("retipy")
reticulate::py_config()
```

## Example 2

```{r}
EX2_DIR <- "~/projects/slendr-paper"
```

```{r, example2_model_definition}
# define an abstract square world map
map <- world(xrange = c(0, 100), yrange = c(0, 100), landscape = "blank")

# create a population with a circular range and schedule a series of
# changes in spatial interaction between individuals over time
pop <- population(
    "pop", time = 1, N = 10000, map = map, center = c(50, 50), radius = 50,
    competition_dist = 5, mate_dist = 5, dispersal_dist = 0.5
  ) %>%
  dispersal(time = 3000, competition_dist = 10) %>%
  dispersal(time = 6000, competition_dist = 15) %>%
  dispersal(time = 9000, competition_dist = 20) %>%
  dispersal(time = 12000, competition_dist = 25) %>%
  dispersal(time = 15000, competition_dist = 30)

# compile a slendr model to a serialized form
model_ex2 <- compile(pop, generation_time = 1, resolution = 1,
                     sim_length = 18000, dir = EX2_DIR, overwrite = TRUE)

# record 50 individuals every hundred generations in the tree sequence
samples <- sampling(model_ex2, seq(100, 18000, by = 200), list(pop, 50))

# execute the model in SLiM, simulationg 100 kb of sequence and saving
# the location of each individual throughout the simulation
slim(model_ex2, sampling = samples, save_locations = TRUE,
     sequence_length = 100e3, recombination_rate = 1e-8, seed = RANDOM_SEED)
```

We can animate the entire model dynamics using the function `animate()`:
```{r, example2_gif}
animate(model_ex2, steps = 1000)
```

Load the location of everyone who ever lived:

```{r, example2_load_locations}
epoch_times <- c(3000, 6000, 9000, 12000, 15000, 18000)

locations <- file.path(model_ex2$path, "/output_ind_locations.tsv.gz") %>%
  read_tsv(show_col_types = FALSE, progress = FALSE) %>%
  mutate(time = 18000 - gen) %>%
  filter(time %in% epoch_times)
```

We can't include the GIF animation of the simulation run in the paper. Instead, let's just take a couple of snapshots from the spatial simulation at each moment when we change the dynamics:

```{r, example2_paper_figure}
time_labeller <- function(value) paste(" ", value, "generations")

ggplot(locations, aes(x, y, color = factor(time))) +
  geom_point(size = 0.05, alpha = 0.25) +
  facet_grid(time ~ ., labeller = labeller(time = time_labeller)) +
  theme_void() +
  theme(
    axis.title = element_blank(), axis.text = element_blank(),
    strip.text.y = element_text(angle = 0, hjust = 0)
  ) +
  coord_fixed() +
  guides(color = "none")
```

## Example 4

Load a couple of libraries for processing and visualising the results, link to the Python environment which contains the necessary Python modules:


```{r, example4_paper_figure}
# load the output tree sequence, recapitate it, simplify it, add mutations
ts <- ts_load(model_ex2, recapitate = TRUE, simplify = TRUE, mutate = TRUE,
              Ne = 10000, recombination_rate = 1e-8, mutation_rate = 1e-8)

# extract table with names and times of sampled individuals
samples <- ts_samples(ts)

# extract just the names of individuals which are used as identifiers in
# various ts_*() statistics functions
groups <- as.list(samples$name)

# compute nucleotide diversity in each simulated individual -- given that
# each SLiM individual carries two chromosome, this is effectively the
# heterozygosity in each individual
result <- ts_diversity(ts, groups)

# add the heterozygosity as a new column to the table of samples
samples <- samples |>
  mutate(
    heterozygosity = result$diversity,
    epoch = findInterval(time, epoch_times, rightmost.closed = TRUE)
  )

# plot heterozygosity over time computed from the tree sequence data,
# coloring each "epoch" corresponding to the change in spatial dynamics
ggplot(samples, aes(time, heterozygosity, color = factor(epoch))) +
  geom_point() +
  geom_smooth(color = "black") +
  geom_vline(xintercept = epoch_times, size = 0.75, alpha = 0.25) +
  scale_x_continuous(breaks = epoch_times, labels = epoch_times) +
  labs(x = "time since the start of the simulation") +
  theme_minimal() + guides(color = "none")
```



<!-- ```{r, example4_paper_figure} -->
<!-- # load the output tree sequence, recapitate it, simplify it, add mutations -->
<!-- ts <- ts_load(model_ex2, recapitate = TRUE, simplify = TRUE, mutate = TRUE, -->
<!--               Ne = 10000, recombination_rate = 1e-8, mutation_rate = 1e-8) -->

<!-- # extract table with names and times of sampled individuals -->
<!-- samples <- ts_samples(ts) -->

<!-- # extract names of individuals in each time point -->
<!-- groups <- split(samples, samples$time) %>% map(pull, name) -->

<!-- # compute nucleotide diversity in each time point and add additional -->
<!-- # information to the table of results for easier plotting -->
<!-- diversity <- ts_diversity(ts, groups) %>% -->
<!--   mutate( -->
<!--     time = as.numeric(set), -->
<!--     epoch = findInterval(time, epoch_times, rightmost.closed = TRUE) -->
<!--   ) -->

<!-- # plot diversity over time computed from the tree sequence data -->
<!-- ggplot(diversity, aes(time, diversity, color = factor(epoch))) + -->
<!--   geom_point() + -->
<!--   geom_smooth(color = "black") + -->
<!--   geom_vline(xintercept = epoch_times, size = 0.75, alpha = 0.25) + -->
<!--   scale_x_continuous(breaks = epoch_times, labels = epoch_times) + -->
<!--   labs(x = "time since the start of the simulation") + -->
<!--   theme_minimal() + guides(color = "none") -->
<!-- ``` -->
