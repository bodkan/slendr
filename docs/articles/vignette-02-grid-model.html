<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Demes on a regular spatial grid • slendr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Demes on a regular spatial grid">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">slendr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-question-circle"></span> Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fa-book"></span> Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/vignette-00-installation.html">Installation instructions</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-01-tutorial.html">Introduction and basic tutorial</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-02-grid-model.html">Demes on a regular spatial grid</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-03-interactions.html">Programming dispersion dynamics</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-04-nonspatial-models.html">Traditional non-spatial models</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-05-tree-sequences.html">Tree sequence processing and statistics</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-06-locations.html">Spatially annotated tree sequences</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-07-backends.html">Simulating data with SLiM and msprime backends</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-08-nonslendr-tskit.html">Analyzing non-slendr tree sequences</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-09-paper.html">Examples from the slendr paper</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-10-tracts.html">Extracting true ancestry tracts</a></li>
    <li><a class="dropdown-item" href="../articles/vignette-11-extensions.html">Extending models with custom SLiM code</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bodkan/slendr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/fleventy5"><span class="fa fa-twitter"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Demes on a regular spatial grid</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bodkan/slendr/blob/HEAD/vignettes/vignette-02-grid-model.Rmd" class="external-link"><code>vignettes/vignette-02-grid-model.Rmd</code></a></small>
      <div class="d-none name"><code>vignette-02-grid-model.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we will build a simple model of isolated
populations laid out on a two-dimensional grid, each exchanging migrants
with its immediate neighbors.</p>
<p>The purpose of the vignette is to demonstrate the power of R as a
foundation for building complex <em>slendr</em> models from simpler
components. Although there is no built-in functionality for such classic
“demes on a regular grid” models in the <em>slendr</em> package, the
fact that we have the complete functionality of R at our disposal makes
it possible to easily program relatively complex models from the
convenient environment of R using a couple of simple model-building
primitives and automatically execute such models in SLiM.</p>
<p>If you have worked with SLiM before, you will recognize that a nearly
identical idea is implemented in SLiM’s Eidos language in section 5.3.3
of the SLiM manual. One difference in this example is that our model is
explicitly spatial, unlike the example from the manual where spatiality
is only approximated using a random-mating model.</p>
<div class="section level2">
<h2 id="simple-two-dimensional-grid-model">Simple two-dimensional grid model<a class="anchor" aria-label="anchor" href="#simple-two-dimensional-grid-model"></a>
</h2>
<p>First, let’s load the <em>slendr</em> R package and create a
two-dimensional abstract world map:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bodkan/slendr" class="external-link">slendr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/init_env.html">init_env</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; The interface to all required Python modules has been activated.</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/world.html">world</a></span><span class="op">(</span></span>
<span>  xrange <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1000</span><span class="op">)</span>,</span>
<span>  yrange <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1000</span><span class="op">)</span>,</span>
<span>  landscape <span class="op">=</span> <span class="st">"blank"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, we define a helper function which will a) create a single
<em>slendr</em> population object, b) place that population at an
appropriate coordinate on the lattice on the world map based on the
numeric identifier of the population <em>i</em> (where <em>i</em> runs
from 1 to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">n \times n</annotation></semantics></math>
, <em>n</em> being the total number of demes along one side of the
regular grid):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">create_pop</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">n_side</span>, <span class="va">map</span>, <span class="va">N</span>, <span class="va">radius</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># get dimensions of the world map</span></span>
<span>  <span class="va">dim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">map</span>, <span class="st">"xrange"</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">map</span>, <span class="st">"yrange"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># position of the i-th population on the two-dimensional lattice grid</span></span>
<span>  <span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">n_side</span>, <span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="va">n_side</span><span class="op">)</span></span>
<span>  <span class="va">center</span> <span class="op">&lt;-</span> <span class="va">coords</span> <span class="op">/</span> <span class="va">n_side</span> <span class="op">*</span> <span class="va">dim</span> <span class="op">+</span> <span class="va">dim</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">n_side</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">pop</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span></span>
<span>      name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"pop%d"</span>, <span class="va">i</span><span class="op">)</span>,</span>
<span>      N <span class="op">=</span> <span class="va">N</span>,</span>
<span>      time <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      map <span class="op">=</span> <span class="va">map</span>,</span>
<span>      center <span class="op">=</span> <span class="va">center</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">map</span>, <span class="st">"xrange"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">map</span>, <span class="st">"yrange"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      radius <span class="op">=</span> <span class="va">radius</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">pop</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Having defined the population construction function, let’s build our
model. Let’s say that we want to create a regular grid of <em>n</em> ×
<em>n</em> populations, with <em>N</em> individuals in each
population:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span></span>
<span><span class="va">populations</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">create_pop</span>, n_side <span class="op">=</span> <span class="va">n</span>, map <span class="op">=</span> <span class="va">map</span>, N <span class="op">=</span> <span class="fl">100</span>, radius <span class="op">=</span> <span class="fl">40</span><span class="op">)</span></span></code></pre></div>
<p>Let’s plot the whole spatial population configuration, to make sure
we set up things correctly:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">plot_map</span>, <span class="va">populations</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="vignette-02-grid-model_files/figure-html/demes_grid-1.png" width="360"></p>
<p>So far, the way the model is specified, each population would be
stuck on its own circular “island”. We can change that by programming
gene flow events using the <em>slendr</em> function
<code><a href="../reference/gene_flow.html">gene_flow()</a></code>. Again, let’s first program a simple helper
function which will generate gene flow events according to neighborhood
relationships on the two-dimensional grid, allowing each population to
exchange migrants with each of its neighbors (making sure the
coordinates of each population stay within the grid using simple modulo
arithmetic on the population index <em>i</em>).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">set_geneflow</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">n_side</span>, <span class="va">rate</span>, <span class="va">start</span>, <span class="va">end</span>, <span class="va">populations</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pop</span> <span class="op">&lt;-</span> <span class="va">populations</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># get the position of the i-th population on the n*n grid</span></span>
<span>  <span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">n_side</span>, <span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="va">n_side</span><span class="op">)</span></span>
<span></span>
<span>   <span class="co"># get coordinates of the i-th population's neighbors on the grid</span></span>
<span>  <span class="va">neighbor_pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span>, <span class="va">coords</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">coords</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">coords</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">coords</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># generate geneflow events for population coordinates inside the grid</span></span>
<span>  <span class="va">geneflows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">neighbor_pos</span>, <span class="kw">function</span><span class="op">(</span><span class="va">pos</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">pos</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">pos</span> <span class="op">&gt;=</span> <span class="va">n_side</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>    <span class="va">neighbor</span> <span class="op">&lt;-</span> <span class="va">populations</span><span class="op">[[</span><span class="va">pos</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">n_side</span> <span class="op">+</span> <span class="va">pos</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">neighbor</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">pop</span>, to <span class="op">=</span> <span class="va">neighbor</span>, rate <span class="op">=</span> <span class="va">rate</span>, start <span class="op">=</span> <span class="va">start</span>, end <span class="op">=</span> <span class="va">end</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">neighbor</span>, to <span class="op">=</span> <span class="va">pop</span>, rate <span class="op">=</span> <span class="va">rate</span>, start <span class="op">=</span> <span class="va">start</span>, end <span class="op">=</span> <span class="va">end</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">geneflows</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s test this function. What would be the gene flow events of the
population in the lower left corner of the grid (so, the very first
population in the series)? If everything works, this population should
only be allowed to exchange migrants with its neighbor to the right
(population number 2) and its neighbor above.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">set_geneflow</span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span>, rate <span class="op">=</span> <span class="fl">0.1</span>, start <span class="op">=</span> <span class="fl">2</span>, end <span class="op">=</span> <span class="fl">1000</span>, <span class="va">populations</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;   from_name to_name tstart tend rate overlap</span></span>
<span><span class="co">#&gt; 1      pop1    pop2      2 1000  0.1   FALSE</span></span>
<span><span class="co">#&gt; 2      pop2    pop1      2 1000  0.1   FALSE</span></span>
<span><span class="co">#&gt; 3      pop1    pop6      2 1000  0.1   FALSE</span></span>
<span><span class="co">#&gt; 4      pop6    pop1      2 1000  0.1   FALSE</span></span></code></pre>
<p>Looks right! Let’s generate the entire set of continuous gene flow
events:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geneflows</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">set_geneflow</span>, <span class="va">n</span>, rate <span class="op">=</span> <span class="fl">0.05</span>, start <span class="op">=</span> <span class="fl">2</span>, end <span class="op">=</span> <span class="fl">1000</span>, <span class="va">populations</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="va">unique</span> <span class="co"># filter out duplicate events due to symmetries</span></span></code></pre></div>
<p>The total number of individual gene flow events is:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">geneflows</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 80</span></span></code></pre>
<p>Finally, we can compile the whole model:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compile_model.html">compile_model</a></span><span class="op">(</span></span>
<span>  populations <span class="op">=</span> <span class="va">populations</span>, gene_flow <span class="op">=</span> <span class="va">geneflows</span>,</span>
<span>  generation_time <span class="op">=</span> <span class="fl">1</span>, resolution <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  competition <span class="op">=</span> <span class="fl">10</span>, mating <span class="op">=</span> <span class="fl">10</span>, dispersal <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  simulation_length <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Those familiar with the SLiM manual will recognize a model described
in section 5.3.3.</p>
<p>Finally, we can run our simulation using the <code><a href="../reference/slim.html">slim()</a></code>
function.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/slim.html">slim</a></span><span class="op">(</span><span class="va">model</span>, sequence_length <span class="op">=</span> <span class="fl">10000</span>, recombination_rate <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># simulate a single 10kb locus</span></span>
<span><span class="va">ts</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; ╔═══════════════════════╗</span></span>
<span><span class="co">#&gt; ║TreeSequence           ║</span></span>
<span><span class="co">#&gt; ╠═══════════════╤═══════╣</span></span>
<span><span class="co">#&gt; ║Trees          │      1║</span></span>
<span><span class="co">#&gt; ╟───────────────┼───────╢</span></span>
<span><span class="co">#&gt; ║Sequence Length│ 10,000║</span></span>
<span><span class="co">#&gt; ╟───────────────┼───────╢</span></span>
<span><span class="co">#&gt; ║Time Units     │  ticks║</span></span>
<span><span class="co">#&gt; ╟───────────────┼───────╢</span></span>
<span><span class="co">#&gt; ║Sample Nodes   │  5,000║</span></span>
<span><span class="co">#&gt; ╟───────────────┼───────╢</span></span>
<span><span class="co">#&gt; ║Total Size     │1.3 MiB║</span></span>
<span><span class="co">#&gt; ╚═══════════════╧═══════╝</span></span>
<span><span class="co">#&gt; ╔═══════════╤═════╤═════════╤════════════╗</span></span>
<span><span class="co">#&gt; ║Table      │Rows │Size     │Has Metadata║</span></span>
<span><span class="co">#&gt; ╠═══════════╪═════╪═════════╪════════════╣</span></span>
<span><span class="co">#&gt; ║Edges      │9,038│282.4 KiB│          No║</span></span>
<span><span class="co">#&gt; ╟───────────┼─────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Individuals│6,250│612.0 KiB│         Yes║</span></span>
<span><span class="co">#&gt; ╟───────────┼─────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Migrations │    0│  8 Bytes│          No║</span></span>
<span><span class="co">#&gt; ╟───────────┼─────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Mutations  │    0│  1.2 KiB│          No║</span></span>
<span><span class="co">#&gt; ╟───────────┼─────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Nodes      │9,063│329.1 KiB│         Yes║</span></span>
<span><span class="co">#&gt; ╟───────────┼─────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Populations│   25│  5.7 KiB│         Yes║</span></span>
<span><span class="co">#&gt; ╟───────────┼─────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Provenances│    1│ 43.1 KiB│          No║</span></span>
<span><span class="co">#&gt; ╟───────────┼─────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Sites      │    0│ 16 Bytes│          No║</span></span>
<span><span class="co">#&gt; ╚═══════════╧═════╧═════════╧════════════╝</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="population-grid-on-a-real-geographic-landscape">Population grid on a real geographic landscape<a class="anchor" aria-label="anchor" href="#population-grid-on-a-real-geographic-landscape"></a>
</h2>
<p>We can take things one step further. What if we wanted to do a
similar thing (i.e. simulate regularly spaced demes) but in a real
geographic context?</p>
<p>Let’s zoom in on some interesting part of the world and then create a
grid of demes using the same helper function <code>create_pop</code> we
defined above (each population boundary being 300 km in diameter):</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/world.html">world</a></span><span class="op">(</span></span>
<span>  xrange <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">25</span>, <span class="fl">55</span><span class="op">)</span>,</span>
<span>  yrange <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">32</span>, <span class="fl">35</span><span class="op">)</span>,</span>
<span>  crs <span class="op">=</span> <span class="fl">4326</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span></span>
<span><span class="va">populations</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">create_pop</span>, n_side <span class="op">=</span> <span class="va">n</span>, map <span class="op">=</span> <span class="va">map</span>, N <span class="op">=</span> <span class="fl">100</span>, radius <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span></code></pre></div>
<p>Of course, when we lay out a regular grid across a map of the world,
some population boundaries would fall outside the African continent. To
solve this issue, we will go through the list of all populations and
filter to those with at least 50% of their area on land, using another
helper function:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">continent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/region.html">region</a></span><span class="op">(</span></span>
<span>  map <span class="op">=</span> <span class="va">map</span>, polygon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">35</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">15</span>, <span class="fl">8</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="op">-</span><span class="fl">40</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">35</span>, <span class="op">-</span><span class="fl">32</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="op">-</span><span class="fl">25</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">55</span>, <span class="op">-</span><span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">53</span>, <span class="fl">13</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">45</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">37</span>, <span class="fl">20</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">30</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">38</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">38</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">check_area</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pop</span>, <span class="va">map</span>, <span class="va">continent</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># total population area</span></span>
<span>  <span class="va">pop_area</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/area.html">area</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span><span class="op">$</span><span class="va">area</span></span>
<span>  <span class="co"># population area overlapping a map</span></span>
<span>  <span class="va">map_area</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/area.html">area</a></span><span class="op">(</span><span class="fu"><a href="../reference/overlap.html">overlap</a></span><span class="op">(</span><span class="va">pop</span>, <span class="va">map</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># population area overlapping African continent</span></span>
<span>  <span class="va">continent_area</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/area.html">area</a></span><span class="op">(</span><span class="fu"><a href="../reference/overlap.html">overlap</a></span><span class="op">(</span><span class="va">pop</span>, <span class="va">continent</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># at least 50% of population's boundary be on land, and it must fall</span></span>
<span>  <span class="co"># on to the African continent itself</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">continent_area</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">||</span> <span class="op">(</span><span class="va">map_area</span> <span class="op">/</span> <span class="va">pop_area</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="kw">else</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">filtered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">populations</span>, <span class="va">check_area</span>, <span class="va">map</span>, <span class="va">continent</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Negate</a></span><span class="op">(</span><span class="va">is.null</span><span class="op">)</span>, <span class="va">.</span><span class="op">)</span></span></code></pre></div>
<p>Let’s plot the layout of the population grid on the real geographic
background:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">plot_map</span>, <span class="va">filtered</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="vignette-02-grid-model_files/figure-html/demes_africa-1.png" width="360"></p>
<p>Next, we would probably set up some scenario of gene flow between
subpopulations; perhaps we would be interested in studying how a
selected allele spreads through the continent based on some factors of
interest. Then, to simulate data from this spatial model, we would first
have to <code><a href="../reference/compile_model.html">compile_model()</a></code> it and then run it in SLiM via the
<code><a href="../reference/slim.html">slim()</a></code> function. Given that this is the same process we
described in the example above, we won’t be repeating it here.</p>
</div>
<div class="section level2">
<h2 id="more-customized-spatial-model">More customized spatial model<a class="anchor" aria-label="anchor" href="#more-customized-spatial-model"></a>
</h2>
<p>If we want to introduce spatiality into our model but need a more
manual control over the position of each subpopulation, we can of course
customize the spatial layout in much more detail.</p>
<p>Consider the followin map of South America:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xrange</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">90</span>, <span class="op">-</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">yrange</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">58</span>, <span class="fl">15</span><span class="op">)</span></span>
<span></span>
<span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/world.html">world</a></span><span class="op">(</span>xrange <span class="op">=</span> <span class="va">xrange</span>, yrange <span class="op">=</span> <span class="va">yrange</span>, crs <span class="op">=</span> <span class="st">"EPSG:31970"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span></span></code></pre></div>
<p><img src="vignette-02-grid-model_files/figure-html/map_america-1.png" width="360"></p>
<p>Let’s lay out demes in a more scattered, irregular fashion. For
illustration purposes, we will define each population’s geographic range
as a circle with the radius of 200 km. Importantly, note that we have
introduced one ancestral population but that that population does not
have an associated location on a world map! Because we want to simulate
data with a coalescent backend, we <em>have</em> to formally encode a
population in which all genealogies eventually coalesce. In other words,
the models we have specified above would not run with the
<code><a href="../reference/msprime.html">msprime()</a></code> back end because they contain isolated demes
which do not formally descend from a single ancestor had we run these
models with msprime, we would get an error about infinite coalescent
times. This is why we formally introduce an ancestral population
here:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># non-spatial ancestral population</span></span>
<span><span class="va">p_anc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="st">"p_anc"</span>, N <span class="op">=</span> <span class="fl">1000</span>, time <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># spatial populations</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="st">"p1"</span>, N <span class="op">=</span> <span class="fl">1000</span>, time <span class="op">=</span> <span class="fl">500</span>, parent <span class="op">=</span> <span class="va">p_anc</span>, map <span class="op">=</span> <span class="va">map</span>, center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">75</span>, <span class="fl">0</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">200e3</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="st">"p2"</span>, N <span class="op">=</span> <span class="fl">1000</span>, time <span class="op">=</span> <span class="fl">500</span>, parent <span class="op">=</span> <span class="va">p_anc</span>, map <span class="op">=</span> <span class="va">map</span>, center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">60</span>, <span class="fl">5</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">200e3</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="st">"p3"</span>, N <span class="op">=</span> <span class="fl">1000</span>, time <span class="op">=</span> <span class="fl">500</span>, parent <span class="op">=</span> <span class="va">p_anc</span>, map <span class="op">=</span> <span class="va">map</span>, center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">65</span>, <span class="op">-</span><span class="fl">5</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">200e3</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="st">"p4"</span>, N <span class="op">=</span> <span class="fl">1000</span>, time <span class="op">=</span> <span class="fl">500</span>, parent <span class="op">=</span> <span class="va">p_anc</span>, map <span class="op">=</span> <span class="va">map</span>, center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">60</span>, <span class="op">-</span><span class="fl">20</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">200e3</span><span class="op">)</span></span>
<span><span class="va">p5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="st">"p5"</span>, N <span class="op">=</span> <span class="fl">1000</span>, time <span class="op">=</span> <span class="fl">500</span>, parent <span class="op">=</span> <span class="va">p_anc</span>, map <span class="op">=</span> <span class="va">map</span>, center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">65</span>, <span class="op">-</span><span class="fl">35</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">200e3</span><span class="op">)</span></span>
<span><span class="va">p6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="st">"p6"</span>, N <span class="op">=</span> <span class="fl">1000</span>, time <span class="op">=</span> <span class="fl">500</span>, parent <span class="op">=</span> <span class="va">p_anc</span>, map <span class="op">=</span> <span class="va">map</span>, center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">69</span>, <span class="op">-</span><span class="fl">42</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">200e3</span><span class="op">)</span></span>
<span><span class="va">p7</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="st">"p7"</span>, N <span class="op">=</span> <span class="fl">1000</span>, time <span class="op">=</span> <span class="fl">500</span>, parent <span class="op">=</span> <span class="va">p_anc</span>, map <span class="op">=</span> <span class="va">map</span>, center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">51</span>, <span class="op">-</span><span class="fl">10</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">200e3</span><span class="op">)</span></span>
<span><span class="va">p8</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="st">"p8"</span>, N <span class="op">=</span> <span class="fl">1000</span>, time <span class="op">=</span> <span class="fl">500</span>, parent <span class="op">=</span> <span class="va">p_anc</span>, map <span class="op">=</span> <span class="va">map</span>, center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">45</span>, <span class="op">-</span><span class="fl">15</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">200e3</span><span class="op">)</span></span>
<span><span class="va">p9</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="st">"p9"</span>, N <span class="op">=</span> <span class="fl">1000</span>, time <span class="op">=</span> <span class="fl">500</span>, parent <span class="op">=</span> <span class="va">p_anc</span>, map <span class="op">=</span> <span class="va">map</span>, center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">71</span>, <span class="op">-</span><span class="fl">12</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">200e3</span><span class="op">)</span></span>
<span><span class="va">p10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="st">"p10"</span>, N <span class="op">=</span> <span class="fl">1000</span>, time <span class="op">=</span> <span class="fl">500</span>, parent <span class="op">=</span> <span class="va">p_anc</span>, map <span class="op">=</span> <span class="va">map</span>, center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">55</span>, <span class="op">-</span><span class="fl">25</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">200e3</span><span class="op">)</span></span></code></pre></div>
<p>Furthermore, let’s say we have a fairly good idea about a very
complex interaction/gene-flow network between each deme, which we can
encode like this (instead of forcing a regular arrangement of demes and
gene-flow interactions in previous examples):</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p2</span>, <span class="va">p1</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p3</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p3</span>, <span class="va">p1</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p2</span>, <span class="va">p3</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p3</span>, <span class="va">p2</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p2</span>, <span class="va">p7</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p7</span>, <span class="va">p2</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p3</span>, <span class="va">p7</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p7</span>, <span class="va">p3</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p7</span>, <span class="va">p8</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p8</span>, <span class="va">p7</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p4</span>, <span class="va">p7</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p7</span>, <span class="va">p4</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p4</span>, <span class="va">p5</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p5</span>, <span class="va">p4</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p5</span>, <span class="va">p6</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p6</span>, <span class="va">p5</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p3</span>, <span class="va">p4</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p4</span>, <span class="va">p3</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p9</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p9</span>, <span class="va">p1</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p3</span>, <span class="va">p9</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p9</span>, <span class="va">p3</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p4</span>, <span class="va">p9</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p9</span>, <span class="va">p4</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p10</span>, <span class="va">p4</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p4</span>, <span class="va">p10</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p10</span>, <span class="va">p8</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p8</span>, <span class="va">p10</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p10</span>, <span class="va">p5</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/gene_flow.html">gene_flow</a></span><span class="op">(</span><span class="va">p5</span>, <span class="va">p10</span>, <span class="fl">0.1</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, overlap <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we can compile the model&amp;nbsp`with a twist, however: because
we will only try to simulate data in a non-spatial way using
<em>msprime</em>, we will skip the serialization of model data to disk,
and skipping all spatial interaction and dispersal parameters. In other
words, we only care about simulating a demographic model of traditional,
Wright-Fisher, random-mating demes and gene flow between them,
<em>not</em> about the dispersal within each individual deme. Why?
Mostly just to demonstrate this is possible! However, there are
certainly situations where this “half-spatial” model would be useful –
for instance, in situation where within-deme individual dynamics are not
of interest, but the location of each subpopulation is.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compile_model.html">compile_model</a></span><span class="op">(</span></span>
<span>  populations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">p_anc</span>, <span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span>, <span class="va">p4</span>, <span class="va">p5</span>, <span class="va">p6</span>, <span class="va">p7</span>, <span class="va">p8</span>, <span class="va">p9</span>, <span class="va">p10</span><span class="op">)</span>, gene_flow <span class="op">=</span> <span class="va">gf</span>,</span>
<span>  generation_time <span class="op">=</span> <span class="fl">1</span>, simulation_length <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>  serialize <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Warning: Model containing a mix of spatial and non-spatial populations will be compiled.</span></span>
<span><span class="co">#&gt; Although this is definitely supported, make sure this is really what you want.</span></span></code></pre>
<pre><code><span><span class="co">#&gt; Warning: Spatial models must be serialized to disk for SLiM to simulate data from.</span></span>
<span><span class="co">#&gt; Compiled like this, your model can only be simulated with msprime.</span></span></code></pre>
<p>We can make sure the demographic model is specified correctly by
quickly visualizing it:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_model.html">plot_model</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<p><img src="vignette-02-grid-model_files/figure-html/model_america-1.png" width="360"></p>
<p>We can also plot the spatial organization of our demes on a map in
all of its glory, including all gene flow events (one arrow per each
unidirectional gene flow). Note that we get a warning message stating
that the (non-spatial) ancestral population won’t be visualized on a
map:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">model</span>, gene_flow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Warning: All gene-flow event will be visualized at once. If you wish to visualize</span></span>
<span><span class="co">#&gt; gene flows at a particular point in time, use the `time` argument.</span></span></code></pre>
<pre><code><span><span class="co">#&gt; Warning: Non-spatial populations in your model won't be visualized</span></span></code></pre>
<p><img src="vignette-02-grid-model_files/figure-html/model_map_america-1.png" width="360"></p>
<p>Finally, we can simulate the tree sequence from the model! Notice
that we are simulating data using <code><a href="../reference/msprime.html">msprime()</a></code>, which is
effectively dropping the continuous space dimension of our model. In
this situation, the map above serves more as a visual aid, making it
easier to set up a complex “spatial” position of demes on a map.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msprime.html">msprime</a></span><span class="op">(</span><span class="va">model</span>, sequence_length <span class="op">=</span> <span class="fl">10e6</span>, recombination_rate <span class="op">=</span> <span class="fl">1e-8</span>, random_seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ts</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; ╔═══════════════════════════╗</span></span>
<span><span class="co">#&gt; ║TreeSequence               ║</span></span>
<span><span class="co">#&gt; ╠═══════════════╤═══════════╣</span></span>
<span><span class="co">#&gt; ║Trees          │     34,057║</span></span>
<span><span class="co">#&gt; ╟───────────────┼───────────╢</span></span>
<span><span class="co">#&gt; ║Sequence Length│ 10,000,000║</span></span>
<span><span class="co">#&gt; ╟───────────────┼───────────╢</span></span>
<span><span class="co">#&gt; ║Time Units     │generations║</span></span>
<span><span class="co">#&gt; ╟───────────────┼───────────╢</span></span>
<span><span class="co">#&gt; ║Sample Nodes   │     22,000║</span></span>
<span><span class="co">#&gt; ╟───────────────┼───────────╢</span></span>
<span><span class="co">#&gt; ║Total Size     │    9.4 MiB║</span></span>
<span><span class="co">#&gt; ╚═══════════════╧═══════════╝</span></span>
<span><span class="co">#&gt; ╔═══════════╤═══════╤═════════╤════════════╗</span></span>
<span><span class="co">#&gt; ║Table      │Rows   │Size     │Has Metadata║</span></span>
<span><span class="co">#&gt; ╠═══════════╪═══════╪═════════╪════════════╣</span></span>
<span><span class="co">#&gt; ║Edges      │182,742│  5.6 MiB│          No║</span></span>
<span><span class="co">#&gt; ╟───────────┼───────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Individuals│ 11,000│300.8 KiB│          No║</span></span>
<span><span class="co">#&gt; ╟───────────┼───────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Migrations │      0│  8 Bytes│          No║</span></span>
<span><span class="co">#&gt; ╟───────────┼───────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Mutations  │      0│ 16 Bytes│          No║</span></span>
<span><span class="co">#&gt; ╟───────────┼───────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Nodes      │ 74,344│  2.0 MiB│          No║</span></span>
<span><span class="co">#&gt; ╟───────────┼───────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Populations│     11│605 Bytes│         Yes║</span></span>
<span><span class="co">#&gt; ╟───────────┼───────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Provenances│      1│ 10.5 KiB│          No║</span></span>
<span><span class="co">#&gt; ╟───────────┼───────┼─────────┼────────────╢</span></span>
<span><span class="co">#&gt; ║Sites      │      0│ 16 Bytes│          No║</span></span>
<span><span class="co">#&gt; ╚═══════════╧═══════╧═════════╧════════════╝</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Martin Petr.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
